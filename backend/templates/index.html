<!DOCTYPE html>
<html>
<head>
    <title>IoT Loadcell Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <style>
        body { 
            font-family: sans-serif; 
            padding: 1rem; 
            background-color: #1e1e1e; 
            color: white; 
        }
        .container { max-width: 800px; margin: 0 auto; }
        .status { 
            padding: 1rem; 
            border-radius: 8px; 
            margin: 1rem 0; 
            background-color: #2a2a2a; 
        }
        .connected { border-left: 4px solid #4CAF50; }
        .disconnected { border-left: 4px solid #f44336; }
        button { 
            margin: 0.5rem; 
            padding: 0.75rem 1.5rem; 
            border: none; 
            border-radius: 4px; 
            cursor: pointer; 
            font-size: 16px; 
        }
        .start-btn { background-color: #4CAF50; color: white; }
        .stop-btn { background-color: #f44336; color: white; }
        .disabled { background-color: #666; cursor: not-allowed; }
        #output { 
            background: #333; 
            padding: 1rem; 
            height: 300px; 
            overflow: auto; 
            white-space: pre-wrap; 
            border-radius: 4px; 
            margin: 1rem 0; 
        }
        .readings { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 1rem; 
            margin: 1rem 0; 
        }
        .reading-card { 
            background: #2a2a2a; 
            padding: 1rem; 
            border-radius: 8px; 
            text-align: center; 
        }
        .reading-value { 
            font-size: 2rem; 
            font-weight: bold; 
            color: #75F94C; 
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>IoT Loadcell Dashboard</h1>
        
        <div id="status" class="status disconnected">
            <h3>Connection Status: <span id="connection-status">Disconnected</span></h3>
            <p>ESP32 Connected: <span id="esp-status">No</span></p>
            <p>Test Status: <span id="test-status">Idle</span></p>
        </div>
        
        <div>
            <button id="start-btn" class="start-btn" onclick="sendCommand('start')">Start Test</button>
            <button id="stop-btn" class="stop-btn disabled" onclick="sendCommand('stop')">Stop Test</button>
        </div>
        
        <div class="readings">
            <div class="reading-card">
                <h4>L</h4>
                <div class="reading-value" id="left-reading">0</div>
            </div>
            <div class="reading-card">
                <h4>R</h4>
                <div class="reading-value" id="right-reading">0</div>
            </div>
        </div>
        
        <h3>Data Log</h3>
        <div id="output">Waiting for connection...</div>
    </div>

    <script>
        const socket = io();
        const output = document.getElementById('output');
        const connectionStatus = document.getElementById('connection-status');
        const espStatus = document.getElementById('esp-status');
        const testStatus = document.getElementById('test-status');
        const statusDiv = document.getElementById('status');
        const startBtn = document.getElementById('start-btn');
        const stopBtn = document.getElementById('stop-btn');
        const leftReading = document.getElementById('left-reading');
        const rightReading = document.getElementById('right-reading');
        
        let isConnected = false;
        let isTesting = false;

        socket.on('connect', () => {
            output.textContent += 'Connected to server\n';
            connectionStatus.textContent = 'Connected';
            statusDiv.className = 'status connected';
            isConnected = true;
            
            // Register as browser client
            socket.emit('register', { type: 'browser' });
            updateButtons();
        });

        socket.on('disconnect', () => {
            output.textContent += 'Disconnected from server\n';
            connectionStatus.textContent = 'Disconnected';
            statusDiv.className = 'status disconnected';
            isConnected = false;
            updateButtons();
        });

        socket.on('sensor_data', (data) => {
            if (data.samples) {
                const samples = data.samples;
                output.textContent += `Received ${samples.length} samples\n`;
                
                // Update latest readings with the last sample
                if (samples.length > 0) {
                    const lastSample = samples[samples.length - 1];
                    leftReading.textContent = lastSample.l || 0;
                    rightReading.textContent = lastSample.r || 0;
                }
                
                // Scroll to bottom
                output.scrollTop = output.scrollHeight;
            }
        });

        socket.on('test_status', (data) => {
            testStatus.textContent = data.status.charAt(0).toUpperCase() + data.status.slice(1);
            isTesting = data.status === 'started';
            updateButtons();
            output.textContent += `Test ${data.status}\n`;
        });

        socket.on('registration_response', (data) => {
            output.textContent += `Registered as ${data.type} client\n`;
        });

        // Update system status periodically
        setInterval(() => {
            if (isConnected) {
                fetch('/api/status')
                    .then(response => response.json())
                    .then(data => {
                        espStatus.textContent = data.esp_connected ? 'Yes' : 'No';
                        isTesting = data.is_testing;
                        updateButtons();
                    })
                    .catch(err => console.error('Error fetching status:', err));
            }
        }, 2000);

        function sendCommand(cmd) {
            if (!isConnected) {
                output.textContent += 'Not connected to server\n';
                return;
            }
            
            socket.emit('browser_command', { cmd: cmd });
            output.textContent += `Sent command: ${cmd}\n`;
        }

        function updateButtons() {
            if (!isConnected) {
                startBtn.className = 'start-btn disabled';
                stopBtn.className = 'stop-btn disabled';
                startBtn.disabled = true;
                stopBtn.disabled = true;
            } else if (isTesting) {
                startBtn.className = 'start-btn disabled';
                stopBtn.className = 'stop-btn';
                startBtn.disabled = true;
                stopBtn.disabled = false;
            } else {
                startBtn.className = 'start-btn';
                stopBtn.className = 'stop-btn disabled';
                startBtn.disabled = false;
                stopBtn.disabled = true;
            }
        }
    </script>
</body>
</html>